[tools]
java = "25"
rust = "1.92"
python = "3.12"
uv = "latest"

[tasks.build]
description = "Build in release mode"
run = "cargo build --release"

[tasks.build-debug]
description = "Build in debug mode"
run = "cargo build"

[tasks.fmt]
description = "Format code with rustfmt"
run = "cargo fmt --all"

[tasks.clippy]
description = "Run clippy lints"
run = "cargo clippy --all-targets --all-features -- -D warnings"

[tasks.check]
description = "Run fmt and clippy checks"
depends = ["fmt", "clippy"]

[tasks.test]
description = "Run all tests"
run = "cargo test --all"

[tasks.clone-test-repos]
description = "Clone aeron, artio, and agrona for real-world testing"
run = """
mkdir -p target
[ -d target/aeron ] || git clone https://github.com/aeron-io/aeron.git target/aeron
[ -d target/artio ] || git clone https://github.com/artiofix/artio.git target/artio
[ -d target/agrona ] || git clone https://github.com/aeron-io/agrona.git target/agrona
"""

[tasks.download-checkstyle]
description = "Download checkstyle jar for benchmarking"
run = """
mkdir -p target
[ -f target/checkstyle-13.0.0-all.jar ] || curl -L -o target/checkstyle-13.0.0-all.jar https://github.com/checkstyle/checkstyle/releases/download/checkstyle-13.0.0/checkstyle-13.0.0-all.jar
"""

[tasks.benchmark]
description = "Run performance benchmark comparing lintal vs checkstyle"
depends = ["build", "clone-test-repos", "download-checkstyle"]
run = "uv run python scripts/benchmark.py"

[tasks.release]
description = "Tag and push a release (usage: mise run release 0.1.6)"
run = """
#!/bin/bash
set -e
VERSION="${1:?Usage: mise run release <version>}"

echo "Updating crate versions to $VERSION..."
for cargo_toml in crates/*/Cargo.toml; do
    awk -v ver="$VERSION" 'BEGIN{} /^version = "/ { printf "version = \\"%s\\"\\n", ver; next } { print }' "$cargo_toml" > "$cargo_toml.tmp"
    mv "$cargo_toml.tmp" "$cargo_toml"
    echo "  Updated $cargo_toml"
done

echo "Running cargo check to verify versions..."
cargo check --all

echo "Running fmt and clippy..."
cargo fmt --all
cargo clippy --all-targets --all-features -- -D warnings

echo "Building release..."
cargo build --release

echo "Committing version bump..."
git add -A
git commit -m "Release v$VERSION"

echo "Pushing commit to remote..."
git push

echo "Tagging v$VERSION..."
git tag "v$VERSION"

echo "Pushing tag..."
git push --tags

echo ""
echo "Release v$VERSION pushed!"
echo "Watch the build: https://github.com/eleventy7/lintal/actions"
"""
